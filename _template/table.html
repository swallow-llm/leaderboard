<div class="card">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs">
      {% for tab in _tabs %}
      <li class="nav-item">
        <a href="#tabs-{{ tab.name }}" class="nav-link{% if loop.first %} active{% endif %}" data-bs-toggle="tab">{{ tab.title }}</a>
      </li>
      {% endfor %}
      <li class="nav-item ms-auto dropdown">
        <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
          <span class="nav-link-icon d-md-none d-lg-inline-block">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
              viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon icon-1">
              <path
                d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z" />
              <path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
            </svg>
          </span>
          <span class="nav-link-title">{{ ui.select }}</span>
        </a>
        <div id="model_selection" class="dropdown-menu">
          {% for selection in ui.model_selection %}
          <button class="dropdown-item" data="{{ selection.name }}">{{ selection.title }}</button>
          {% endfor %}
        </div>
      </li>
    </ul>
  </div>
  <div class="card-body">
    <div class="tab-content">
      {% for tab in _tabs %}
      <div class="tab-pane{% if loop.first %} active show{% endif %}" id="tabs-{{ tab.name }}">
        <div class="table-responsive">
          <table class="table card-table table-vcenter text-nowrap datatable">
            <thead>
              <tr>
                <th class="w-1"><input class="form-check-input m-0 align-middle" type="checkbox" aria-label="Select all models" name="__ALL__"></th>
                <th class="text-center">{{ ui.model.name }}</th>
                {% for category, name in tab.columns %}
                <th class="text-center">{{ taskspec[category].taskdict[name].short }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for id, model in models.items() %}
              <tr>
                <td><input class="form-check-input m-0 align-middle" type="checkbox" aria-label="Select model" name="{{ model.id }}"></td>
                <td><a href="{{ model.id | replace('/', '_') }}.{{ lang }}.html">{{ model.name }}</a> <a href="{{ model.url }}"><svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-external-link"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 6h-6a2 2 0 0 0 -2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-6" /><path d="M11 13l9 -9" /><path d="M15 4h5v5" /></svg></a></td>
                {% for category, name in tab.columns %}
                {% set value = model.results[category][name] %}
                <td class="text-end">{% if 0 <= value %}{{ '%0.3f' | format(value | float) }}{% endif %}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  // @formatter:off
  document.addEventListener("DOMContentLoaded", function () {
    console.log(g_filter);
    g_filter.forEach(function(id) {
      document.querySelectorAll('input[name="'+id+'"]').forEach(function(e) {
        e.checked = true;
      });
    });
    if (g_filter.length == Object.keys(g_models).length) {
      document.querySelectorAll('th > input').forEach(function(e) {
        e.checked = true;
      });
    }

    var check = function(id, checked) {
      document.querySelectorAll('input[name="'+id+'"]').forEach(function(e) {
        e.checked = checked;
      });
    };

    var check_all = function(checked) {
      document.querySelectorAll('th > input').forEach(function(e) {
        e.checked = checked;
      });
      document.querySelectorAll('td > input').forEach(function(e) {
        e.checked = checked;
      });
    };

    document.querySelectorAll('#model_selection > button').forEach(e => e.onclick = function() {
      const selections = {{ ui.model_selection | tojson }};

      // Uncheck all models.
      check_all(false);

      for (let selection of selections) {
        if (selection.name == e.getAttribute("data")) {
          const query = selection.query;
          const models = swallow_leaderboard_models(query);

          g_filter = [];
          for (let model of models) {
            g_filter.push(model.id);
            check(model.id, true);
          }
        }
      }

      if (g_filter.length == Object.keys(g_models).length) {
        check_all(true);
      }

      swallow_leaderboard_update("", {models: {includes: g_filter}});
    });

    document.querySelectorAll('td > input').forEach(e => e.onclick = function() {
      const id = this.name;
      const checked = this.checked;
      if (checked) {
        if (g_filter === null) {
          g_filter = [id];
        } else {
          g_filter.push(id);
        }
      } else {
        var i = g_filter.indexOf(id);
        if (i !== -1) {
          g_filter.splice(i, 1);
        }
      }

      // Update check states in other tabs.
      check(checked);

      swallow_leaderboard_update("", {models: {includes: g_filter}});
    });

    document.querySelectorAll('th > input').forEach(e => e.onclick = function() {
      const id = this.name;
      const checked = this.checked;
      if (checked) {
        for (let key in g_models) {
          g_filter.push(g_models[key].id);
        }
      } else {
        g_filter = [];
      }

      check_all(checked);
      swallow_leaderboard_update("", {models: {includes: g_filter}});
    });
  });
// @formatter:on
</script>
